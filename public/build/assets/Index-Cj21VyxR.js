import{r as i,j as e,H as U}from"./app-DHCAgeO8.js";import{f as N,e as Y,A as W,a as Q}from"./AuthenticatedLayout-dBQysIGU.js";import g from"./StatCard-Ce6-1KQE.js";import R from"./ChartCard-BIgSo1eE.js";import z from"./RiceBalanceChart-DyTeNSHC.js";import G from"./AmountBreakdownChart-Bo8Ykzeu.js";import K from"./DailyAmountChart-BKHneoca.js";import V from"./RecentConsumptions-DGkekGX3.js";import X from"./ActivityFeed-zRILTOc7.js";import{R as M}from"./refresh-cw-CDdiVQQp.js";import{P as Z}from"./package-DRaxT-da.js";import{T as ee}from"./trending-down-CeSOmO-w.js";import{s as te,D as ae,C as se,F as oe}from"./startOfMonth-Br8VP5U2.js";import{U as re}from"./users-B-4uzz7n.js";import{C as k}from"./chart-column-CBUKGc-4.js";import"./ApplicationLogo-Da_2dMoK.js";import"./transition-jgp50ovQ.js";import"./createLucideIcon-DQAdNBRm.js";import"./send-BtT_p_gw.js";import"./card-CU-RSoNk.js";import"./arrow-up-right-C-RfYmSH.js";import"./circle-alert-CTSCcRL4.js";import"./ThemeContext-EnF1JpCF.js";import"./CategoricalChart-B_DM5-VD.js";import"./clsx-B-dksMZM.js";import"./index-Ba4gUWok.js";import"./with-selector-ClQDlPES.js";import"./AreaChart-Bfi5mQLk.js";import"./ActivePoints-CV4672Dv.js";import"./ReactUtils-CHPHKHfT.js";import"./CartesianChart-DWSN_jJT.js";import"./getRadiusAndStrokeWidthFromDot-CJLef0io.js";import"./LineChart-kBUcZiSg.js";import"./ErrorBarContext-AjH_zAA5.js";import"./Legend-NZY6pfzZ.js";import"./PolarChart-Bcs1AVNG.js";import"./tooltipContext-D5fRwJRy.js";import"./BarChart-BtxVG7T5.js";import"./calendar-CHi90Qvn.js";import"./activity-CPWM8ihX.js";import"./clock-D9dOGNBG.js";import"./trash-2-r-OwMlc6.js";import"./square-pen-C4DIirRz.js";import"./plus-D7_72eyU.js";const u=async(s,a={})=>{try{const r=await fetch(s,{headers:{Accept:"application/json","Content-Type":"application/json",...a.headers},credentials:"include",...a});if(!r.ok){const o=await r.json().catch(()=>({}));throw new Error(o.message||`HTTP ${r.status}: ${r.statusText}`)}return{success:!0,data:await r.json()}}catch(r){return console.error("API Request Error:",r),{success:!1,error:r.message}}},h=s=>{const a=new URLSearchParams;Object.entries(s).forEach(([b,o])=>{o!=null&&o!==""&&a.append(b,o)});const r=a.toString();return r?`?${r}`:""},y={getSummary:async(s={})=>{const a=h(s);return u(`/api/dashboard/summary${a}`)},getRiceBalanceTimeseries:async(s={})=>{const a=h(s);return u(`/api/dashboard/rice-balance${a}`)},getDailyAmountChart:async(s={})=>{const a=h(s);return u(`/api/dashboard/daily-amount${a}`)},getAmountBreakdown:async(s={})=>{const a=h(s);return u(`/api/dashboard/breakdown${a}`)},getRecentConsumptions:async(s={})=>{const a=h(s);return u(`/api/dashboard/recent${a}`)},getConsumptions:async(s={})=>{const a=h(s);return u(`/api/dashboard/consumptions${a}`)},getActivityFeed:async(s={})=>{const a=h(s);return u(`/api/dashboard/activity${a}`)}};function Ke({auth:s,defaults:a,quickStats:r,schoolTypes:b}){const[o,C]=i.useState(!1),[l,T]=i.useState(a.month),[c,$]=i.useState(a.year),[B,F]=i.useState({start:a.dateRange.start,end:a.dateRange.end}),[d,P]=i.useState(r||{totalRiceAvailable:0,monthlyConsumption:0,monthlySpending:0,studentsServedThisMonth:0,daysServedThisMonth:0,totalStudents:0}),[f,x]=i.useState([]),[v,S]=i.useState({}),[j,w]=i.useState([]),_=Array.from({length:6},(t,n)=>a.year-n),q=[{value:1,label:"January"},{value:2,label:"February"},{value:3,label:"March"},{value:4,label:"April"},{value:5,label:"May"},{value:6,label:"June"},{value:7,label:"July"},{value:8,label:"August"},{value:9,label:"September"},{value:10,label:"October"},{value:11,label:"November"},{value:12,label:"December"}],A=a.schoolType||"primary",D=async()=>{C(!0),console.log(" Fetching dashboard data for:",{year:c,month:l});try{console.log(" Fetching summary statistics...");const t=await y.getSummary({year:c,month:l});console.log(" Summary response:",t),t.success?P({totalRiceAvailable:t.data.rice_available||0,monthlyConsumption:t.data.rice_consumed||0,monthlySpending:t.data.amount_spent||0,studentsServedThisMonth:t.data.students_served||0,daysServedThisMonth:t.data.days_served||0,totalStudents:t.data.total_students||0}):console.error(" Summary API failed:",t.error),console.log(" Fetching rice balance chart data...");const n=await y.getRiceBalanceTimeseries({year:c,month:l});console.log(" Rice balance response:",n),n.success?(x(n.data||[]),console.log(" Rice balance data set:",n.data?.length||0,"entries")):(console.error(" Rice balance API failed:",n.error),x([])),console.log(" Fetching amount breakdown chart data...");const m=await y.getAmountBreakdown({year:c,month:l});console.log(" Amount breakdown response:",m),m.success?(S(m.data||{}),console.log(" Amount breakdown data set:",m.data)):(console.error(" Amount breakdown API failed:",m.error),S({})),console.log(" Fetching daily amount chart data...");const p=await y.getDailyAmountChart({year:c,month:l});console.log(" Daily amount response:",p),p.success?(w(p.data||[]),console.log(" Daily amount data set:",p.data?.length||0,"entries")):(console.error(" Daily amount API failed:",p.error),w([]))}catch(t){console.error(" Critical error fetching dashboard data:",t),x([]),S({}),w([])}finally{C(!1),console.log(" Dashboard data fetch completed")}};i.useEffect(()=>{const t=new Date(c,l-1,1),n=N(te(t),"yyyy-MM-dd"),m=N(Y(t),"yyyy-MM-dd");F({start:n,end:m})},[l,c]),i.useEffect(()=>{D()},[B]);const E=t=>{T(parseInt(t.target.value))},I=t=>{$(parseInt(t.target.value))},L=()=>{D()},O=d.totalStudents>0?Math.round(d.studentsServedThisMonth/d.totalStudents*100):0,H=t=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(t),J=!v||["pulses_total","vegetables_total","oil_total","salt_total","fuel_total"].every(t=>{const n=parseFloat(v[t]??0);return!n||n<=0});return e.jsxs(W,{user:s.user,header:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold text-secondary-900",children:"Dashboard"}),e.jsxs("p",{className:"text-sm text-secondary-600 mt-1",children:["Welcome back, ",e.jsx("span",{className:"font-semibold text-primary-600",children:s.user.name})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-card border border-secondary-200 rounded-lg px-3 py-2",children:[e.jsx(oe,{className:"w-4 h-4 text-secondary-500"}),e.jsx("select",{value:l,onChange:E,className:"border-0 bg-transparent text-sm font-medium text-secondary-700 focus:outline-none focus:ring-0 cursor-pointer",disabled:o,children:q.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx("select",{value:c,onChange:I,className:"border-0 bg-transparent text-sm font-medium text-secondary-700 focus:outline-none focus:ring-0 cursor-pointer",disabled:o,children:_.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("button",{onClick:L,disabled:o,className:"inline-flex items-center justify-center px-4 py-2 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm hover:shadow",children:[e.jsx(M,{className:`w-4 h-4 mr-2 ${o?"animate-spin":""}`}),"Refresh"]})]})]}),children:[e.jsx(U,{title:"Dashboard"}),e.jsx("div",{className:"py-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:[o&&e.jsxs("div",{className:"mb-6 bg-info-50 border border-info-200 text-info-700 px-4 py-3 rounded-lg flex items-center",children:[e.jsx(M,{className:"w-4 h-4 mr-2 animate-spin"}),e.jsx("span",{className:"text-sm font-medium",children:"Loading dashboard data..."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsx(g,{title:"Rice Available",value:`${d.totalRiceAvailable?.toLocaleString()||0} kg`,subtitle:"Current Stock",icon:Z,variant:"primary",loading:o}),e.jsx(g,{title:"Monthly Consumption",value:`${d.monthlyConsumption?.toLocaleString()||0} kg`,subtitle:`${d.daysServedThisMonth||0} days served`,icon:ee,variant:"warning",loading:o}),e.jsx(g,{title:"Monthly Spending",value:H(d.monthlySpending||0).replace("₹","₹"),subtitle:"This Month",icon:ae,variant:"success",loading:o}),e.jsx(g,{title:"Students Served",value:d.studentsServedThisMonth?.toLocaleString()||0,subtitle:`${O}% of ${d.totalStudents||0} total`,icon:re,variant:"info",loading:o})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8",children:[e.jsx(R,{title:"Rice Balance Trend",subtitle:"Last 30 Days",icon:k,loading:o,isEmpty:!f||f.length===0,emptyMessage:"No rice balance data available",height:"h-80",children:e.jsx(z,{data:f,schoolType:A})}),e.jsx(R,{title:"Amount Breakdown",subtitle:"This Month",icon:se,loading:o,isEmpty:J,emptyMessage:"No amount breakdown data available",height:"h-80",children:e.jsx(G,{data:v,isDonut:!0})})]}),e.jsx("div",{className:"mb-8",children:e.jsx(R,{title:"Daily Spending",subtitle:"Last 30 Days",icon:k,loading:o,isEmpty:!j||j.length===0,emptyMessage:"No daily spending data available",height:"h-80",children:e.jsx(K,{data:j,schoolType:A})})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(V,{selectedMonth:l,selectedYear:c,schoolType:A,limit:5,showPagination:!1}),e.jsx(X,{userId:s.user.id,limit:10,autoRefresh:!1})]})]})}),e.jsx(Q,{})]})}export{Ke as default};
